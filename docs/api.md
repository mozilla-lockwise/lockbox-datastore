---
title: API documentation
layout: default
---

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

-   [DataStore](#datastore)
    -   [prepare](#prepare)
    -   [prompts](#prompts)
    -   [initialized](#initialized)
    -   [initialize](#initialize)
    -   [locked](#locked)
    -   [lock](#lock)
    -   [unlock](#unlock)
    -   [list](#list)
    -   [get](#get)
    -   [add](#add)
    -   [update](#update)
    -   [remove](#remove)
-   [create](#create)
-   [open](#open)
-   [ItemKeyStore](#itemkeystore)
    -   [masterKey](#masterkey)
    -   [group](#group)
    -   [iterations](#iterations)
    -   [salt](#salt)
    -   [encrypted](#encrypted)
    -   [toJSON](#tojson)
    -   [load](#load)
    -   [save](#save)
    -   [clear](#clear)
    -   [size](#size)
    -   [get](#get-1)
    -   [add](#add-1)
    -   [delete](#delete)
    -   [encrypt](#encrypt)
    -   [decrypt](#decrypt)

## DataStore

Represents item storage.

**Parameters**

-   `cfg`  

### prepare

Prepares this DataStore. This method:

1.  initializes and opens the local database; and
2.  loads any stored keys from the local database.

If the database is already prepared, this method does nothing.

Returns **[DataStore](#datastore)** This DataStore.

### prompts

The prompt handling functions configured in this DataStore.

The `{unlock}` handler function is expected to match the
following:

    async function(request) {
       // {request} is an Object containing the following members:
       request.error;    // an Error describing a previous failure, if any
       request.attempts; // the Number of attempts so far (including this one)
       // returns a Promise containing the unlock secret (as a string)
    }

**Properties**

-   `unlock` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** The prompt function called to handle {unlock}.

### initialized

Indicates whether this DataStore is initialized.

### initialize

Initializes this DataStore with the given options. This method
creates an empty item keystore, and encrypts it using the password
specified in `{opts}`.

If no `{salt}` is provided, a randomly generated 16-byte value is used.

**Parameters**

-   `opts` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The initialization options
    -   `opts.password` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The master password to lock with (optional, default `""`)
    -   `opts.salt` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)?** The salt to use in deriving the master
               key.
    -   `opts.iterations` **[Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)** The iteration count to use in
               deriving the master key (optional, default `8192`)

### locked

Indicates if this datastore is locked or unlocked.

### lock

Locks this datastore.

Returns **[DataStore](#datastore)** This DataStore once locked

### unlock

Attempts to unlock this datastore.

Returns **[DataStore](#datastore)** This DataStore once unlocked

### list

Retrieves all of the items stored in this DataStore.

Returns **[Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map)&lt;[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String), [Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)>** The map of stored item, by id

### get

Retrieves a single item from this DataStore

**Parameters**

-   `id` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The item id to retrieve

Returns **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The JSON representing the item, or `null` if there is
         no item for `{id}`

### add

Adds a new item to this DataStore.

The `{id}` of the item is replaced with a new UUID.

**Parameters**

-   `item` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The item to add


-   Throws **[TypeError](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypeError)** if `item` is invalid

Returns **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The added item, with all fields completed

### update

Updates an existing item in this DataStore.

**Parameters**

-   `item` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The item to update


-   Throws **[Error](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)** if this item does not exist
-   Throws **[TypeError](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypeError)** if `item` is invalid

Returns **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The updated item

### remove

Removes an item from this DataStore.

**Parameters**

-   `id` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The item id to remove

Returns **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The removed item, or `null` if no item was removed

## create

**Parameters**

-   `cfg` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)?** The configuration parameters; see [open](#open) For
                    supported parameters.

Returns **[DataStore](#datastore)** A new DataStore

**Meta**

-   **deprecated**: Replaced with the async function [open](#open), which
    both creates and prepares the DataStore.

    Creates a new {DataStore} using the given configuration.


## open

Creates a new {DataStore} using the given configuration, and prepares it
for use.  This method calls [DataStore#prepare](#datastoreprepare), returning the
(promised) DataStore once it's ready for use.

**Parameters**

-   `cfg` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)?** The configuration parameters
    -   `cfg.bucket` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The bucket to persist data to (optional, default `"lockbox"`)
    -   `cfg.prompts` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)?** The initial set of callback [DataStore#prompts](#datastoreprompts) for this DataStore.

Returns **[DataStore](#datastore)** A new (prepared) DataStore

## ItemKeyStore

Manages a set of item keys. This includes generation, encryption, and
decryption of the set.

**Parameters**

-   `self`  

### masterKey

The master encryption key.

### group

The group name.

### iterations

The PBKDF2 iteration count when next saving.

### salt

The PBKDF2 salt when next encrypting.

### encrypted

The encrypted key set, as a Compact JWE.

### toJSON

Creates a JSON representation of this ItemKeyStore.  This method returns
a plain Object with the following properties:

-   `group` {**String**} The name of the keystore's group
-   `salt` {**String**} The next PBKDF2 salt when saving
-   `iterations` {**Number**} The PBKDF2 iteration count when saving
-   `encrypted` {**Stirng**} The encrypted map of keys

### load

Loads the item keys.  This method decrypts the stored encrypted key set
using the current or specified master encryption key.

If `{master}` is provided, it overwrites the current master encryption
key.

**Parameters**

-   `master` **jose.JWK.Key?** The new master encryption key to use


-   Throws **[Error](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)** If the master encryption key is not set, or there is
            no encrypted key set, or encryption fails

Returns **[ItemKeyStore](#itemkeystore)** This ItemKeyStore

### save

Saves the item keys.  This method serializes the item keys into and
encrypts them using the current master encryption key.

Once this method completes, `{encrypted}` is set to the newly encrypted
key set.

-   Throws **[Error](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)** If the master encryption key is invalid, or encryption
            fails

Returns **[ItemKeyStore](#itemkeystore)** This ItemKeyStore

### clear

Clears all decrypted values.

Returns **[ItemKeyStore](#itemkeystore)** This ItemKeyStore

### size

The number of item keys available (not encrypted).

### get

Retrieves an item key for the given id.

**Parameters**

-   `id` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The item key identifier

Returns **jose.JWK.Key** The item key, or `undefined` if not known

### add

Adds an item key for the given id.  If a key for `{id}` is already
known, it is returned instead of generating a new one.

**Parameters**

-   `id` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The item key identifier

Returns **jose.JWK.Key** The new or existing item key

### delete

Removes the item key for the given id.

**Parameters**

-   `id` **Stirng** The item key identifier

### encrypt

Encrypts an item.

The `{item}` is expected to have a string `id` property, which is
used to match it its key.  If a key for the item's id does not exist,
it is first created.

**Parameters**

-   `item` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The item to encrypt


-   Throws **[Error](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)** if `{item}` is invalid, or if encryption failed

Returns **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The encrypted item as a compact JWE

### decrypt

Decrypts an item.

**Parameters**

-   `id` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The item id
-   `jwe` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The encrypted item as a compact JWE


-   Throws **[Error](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)** if `{id}` or `{jwe}` is invalid, or if dencryption failed

Returns **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The decrypted item
